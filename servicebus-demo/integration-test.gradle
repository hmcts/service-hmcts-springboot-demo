tasks.register('integrationTest', Test) {
  description = "Runs integration / service bus tests against docker-compose stack"
  group = "Verification"

  testClassesDirs = sourceSets.test.output.classesDirs
  classpath = sourceSets.test.runtimeClasspath
  useJUnitPlatform()
  filter {
    includeTestsMatching '*Integration*'
  }

  // Enable test output and logging
  testLogging {
    events "passed", "skipped", "failed", "standardOut", "standardError"
    exceptionFormat "full"
    showStandardStreams = true
    showExceptions = true
    showCauses = true
    showStackTraces = true
  }

  // Output to console
  outputs.upToDateWhen { false }

  // Print test results
  afterSuite { desc, result ->
    if (!desc.parent) {
      println "\nTest Results: ${result.resultType} (${result.testCount} tests, ${result.successfulTestCount} passed, ${result.failedTestCount} failed, ${result.skippedTestCount} skipped)"
    }
  }

  dependsOn tasks.composeUp
  finalizedBy tasks.composeDown
}

// Regular 'test' task should NOT depend on integrationTest. This allows unit tests to run without Docker
// Only run integrationTest explicitly when you need Docker

sourceSets {
  integrationTest {
    java {
      compileClasspath += sourceSets.main.output
      runtimeClasspath += sourceSets.main.output
    }
  }
}

configurations {
  integrationTestImplementation.extendsFrom testImplementation
  integrationTestRuntimeOnly.extendsFrom testRuntimeOnly
}

dockerCompose {
  // Use test-specific compose file without healthchecks (Gradle plugin waits for healthchecks which fail on Apple Silicon)
  useComposeFiles = ['docker/docker-compose-test.yml']
  startedServices = ['mssql','servicebus-emulator']

  buildBeforeUp = false  // Changed to false - for pre-built images usage, no need to build

  // Don't wait for TCP ports or healthchecks - as they are failing on Apple Silicon
  // Containers will start, and tests will wait a bit before running
  waitForTcpPorts = false

  // Remove --wait flag - it waits for healthchecks which fail on Apple Silicon
  // Containers will start immediately, tests will handle readiness checks
  upAdditionalArgs = []  // Removed --wait to avoid healthcheck timeout

  captureContainersOutput = true
  removeOrphans = true
  stopContainers = true
  removeContainers = true

  useDockerComposeV2 = true
  dockerExecutable = 'docker'
}